<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”æ¸©é‡‡é›†åŠ©æ‰‹ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4 text-white">
    <div class="glass p-8 md:p-12 rounded-3xl shadow-2xl max-w-md w-full text-center fade-in relative overflow-hidden">
        <!-- Decoration -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500"></div>

        <h1 class="text-2xl font-bold mb-2 tracking-wide text-white drop-shadow-md">å®æ—¶æ°”æ¸©é‡‡é›†</h1>
        <p class="text-white/70 text-sm mb-10">è‡ªåŠ¨å®šä½ Â· ç²¾å‡†åŒæ­¥</p>

        <div class="mb-10 relative">
            <div class="flex justify-center items-baseline space-x-2">
                <span id="temp" class="text-8xl font-thin tracking-tighter drop-shadow-lg">--</span>
                <span class="text-4xl text-white/60 font-light">Â°C</span>
            </div>
            <div id="loading-spinner" class="hidden absolute inset-0 flex items-center justify-center bg-transparent">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            </div>
        </div>

        <p id="status"
            class="text-sm font-medium text-white/90 mb-8 bg-black/20 py-3 px-6 rounded-full inline-block backdrop-blur-sm border border-white/10 shadow-inner max-w-full truncate">
            â³ ç³»ç»Ÿåˆå§‹åŒ–...
        </p>

        <button id="mainBtn" onclick="collectData()"
            class="w-full bg-white text-indigo-600 font-bold py-4 px-6 rounded-2xl transition-all hover:bg-opacity-90 active:scale-95 shadow-lg hover:shadow-xl hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
            åˆ·æ–°æ•°æ®
        </button>

        <div class="mt-8 text-xs text-white/40">
            Powered by Amap & Supabase
        </div>
    </div>

    <!-- æ ¸å¿ƒé€»è¾‘ -->
    <script>
        // === æ ¸å¿ƒé…ç½® ===
        const AMAP_KEY = 'e1fc7c73639f76133ba37398e9d68ffe';
        const SUPABASE_URL = 'https://rhgvuveblnwznemndvpx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_OjgMOfIsUcOK9iYSuZ76wg_6FEvzdB8';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function collectData() {
            const btn = document.getElementById('mainBtn');
            const status = document.getElementById('status');
            const tempDisplay = document.getElementById('temp');
            const spinner = document.getElementById('loading-spinner');

            btn.disabled = true;
            spinner.classList.remove('hidden');
            tempDisplay.classList.add('opacity-50');
            status.innerText = "ğŸ“ æ­£åœ¨å®šä½...";

            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå®šä½
            if (!navigator.geolocation) {
                status.innerText = "âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½";
                resetUI();
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                // é«˜å¾·è¦æ±‚ç»åº¦åœ¨å‰ï¼Œçº¬åº¦åœ¨åï¼Œç”¨é€—å·éš”å¼€
                const lon = pos.coords.longitude.toFixed(6);
                const lat = pos.coords.latitude.toFixed(6);
                const locationStr = `${lon},${lat}`;

                status.innerText = `ğŸŒ å®šä½æˆåŠŸï¼Œè§£æä¸­...`;

                try {
                    // 1. é€†åœ°ç†ç¼–ç  (è·å–åŸå¸‚Adcode)
                    const geoRes = await fetch(`https://restapi.amap.com/v3/geocode/regeo?location=${locationStr}&key=${AMAP_KEY}`);
                    const geoData = await geoRes.json();

                    if (geoData.info !== "OK") throw new Error("KeyéªŒè¯å¤±è´¥æˆ–é¢åº¦ä¸è¶³: " + (geoData.info || "æœªçŸ¥é”™è¯¯"));

                    const adcode = geoData.regeocode.addressComponent.adcode;
                    const district = geoData.regeocode.addressComponent.district;
                    const city = geoData.regeocode.addressComponent.city;
                    const locationName = (typeof district === 'string' && district.length > 0) ? district : city;

                    status.innerText = `ğŸ“ ${locationName} | è¯»å–æ°”æ¸©...`;

                    // 2. è·å–å¤©æ°”
                    const weatherRes = await fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=${adcode}&key=${AMAP_KEY}`);
                    const weatherData = await weatherRes.json();

                    if (weatherData.info === "OK" && weatherData.lives.length > 0) {
                        const t = weatherData.lives[0].temperature;

                        // æ›´æ–°UI
                        tempDisplay.innerText = t;
                        tempDisplay.classList.remove('opacity-50');
                        spinner.classList.add('hidden');

                        status.innerText = "â˜ï¸ æ°”æ¸©è¯»å–æˆåŠŸï¼Œä¸Šä¼ ä¸­...";

                        // 3. å†™å…¥æ•°æ®åº“
                        const { error } = await supabaseClient
                            .from('weather_logs')
                            .insert([{ temp: t, lat: lat, lon: lon }]);

                        if (error) throw error;

                        status.innerHTML = "âœ… <span class='font-bold'>åŒæ­¥æˆåŠŸ</span> | æ•°æ®å·²å…¥åº“";
                        status.classList.add('text-green-300');
                        setTimeout(() => status.classList.remove('text-green-300'), 3000);

                    } else {
                        throw new Error("å¤©æ°”æŸ¥è¯¢å¤±è´¥");
                    }
                } catch (e) {
                    console.error(e);
                    status.innerText = "ğŸš¨ " + e.message;
                    tempDisplay.innerText = "--";
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    tempDisplay.classList.remove('opacity-50');
                }
            }, (err) => {
                // å®šä½å¤±è´¥å¤„ç†
                console.warn(err);
                let errorMsg = "å®šä½å¤±è´¥";
                switch (err.code) {
                    case err.PERMISSION_DENIED: errorMsg = "ç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚"; break;
                    case err.POSITION_UNAVAILABLE: errorMsg = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨"; break;
                    case err.TIMEOUT: errorMsg = "è¯·æ±‚è¶…æ—¶"; break;
                }
                status.innerText = "âš ï¸ " + errorMsg;
                btn.disabled = false;
                spinner.classList.add('hidden');
                tempDisplay.classList.remove('opacity-50');
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }

        function resetUI() {
            const btn = document.getElementById('mainBtn');
            btn.disabled = false;
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('temp').classList.remove('opacity-50');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è§¦å‘
        window.addEventListener('load', () => {
            collectData();
        });
    </script>
</body>

</html>
