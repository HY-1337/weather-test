<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”æ¸©é‡‡é›†åŠ©æ‰‹ Pro - æ˜¥èŠ‚ç‰¹ä¾›ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            overflow-x: hidden;
            /* é˜²æ­¢è£…é¥°ç‰©æº¢å‡º */
        }

        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡éšè— */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* === æ˜¥èŠ‚è£…é¥° === */

        /* ç¯ç¬¼æ™ƒåŠ¨åŠ¨ç”» */
        @keyframes swing {
            0% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }

            100% {
                transform: rotate(-5deg);
            }
        }

        .lantern {
            position: absolute;
            top: 0;
            width: 80px;
            height: 100px;
            /* çº¿+ç¯ç¬¼ä¸»ä½“ */
            z-index: 1;
            transform-origin: top center;
            animation: swing 3s infinite ease-in-out;
            pointer-events: none;
            /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€ */
        }

        .lantern-body {
            width: 60px;
            height: 50px;
            background: #d80000;
            border-radius: 30px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(220, 0, 0, 0.4);
            border: 2px solid #ffde00;
        }

        .lantern-body::before,
        .lantern-body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            border: 1px solid #ffde00;
            border-radius: 50%;
            transform: translateX(-50%);
        }

        .lantern-body::before {
            width: 30px;
        }

        .lantern-body::after {
            width: 45px;
        }

        .lantern-line {
            width: 2px;
            height: 20px;
            background: #ffde00;
            margin: 0 auto;
        }

        .lantern-tassel {
            width: 4px;
            height: 30px;
            background: #ffde00;
            margin: 0 auto;
            border-radius: 0 0 5px 5px;
        }

        /* è£…é¥°å¯¹è” (ä»…æ¡Œé¢ç«¯æ˜¾ç¤º) */
        @media (min-width: 1024px) {
            .couplet {
                position: fixed;
                top: 50%;
                transform: translateY(-50%);
                width: 60px;
                padding: 20px 0;
                background: #d80000;
                color: #ffde00;
                font-size: 32px;
                font-weight: bold;
                text-align: center;
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                writing-mode: vertical-rl;
                letter-spacing: 12px;
                border: 2px solid #ffde00;
                text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.1);
                z-index: 0;
            }

            .couplet.left {
                left: 5%;
            }

            .couplet.right {
                right: 5%;
            }
        }

        /* ç§»åŠ¨ç«¯ä¸æ˜¾ç¤ºå¯¹è” */
        @media (max-width: 1023px) {
            .couplet {
                display: none;
            }
        }

        /* === çˆ†ç«¹åŠ¨ç”» === */
        @keyframes firecracker-shake {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(5deg);
            }

            75% {
                transform: rotate(-5deg);
            }
        }

        @keyframes spark-flash {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        .firecracker-container {
            position: fixed;
            bottom: 20px;
            z-index: 20;
            cursor: pointer;
            transition: transform 0.2s;
            animation: firecracker-shake 3s infinite ease-in-out;
            /* å¢åŠ æ•´ä½“æ™ƒåŠ¨ */
        }

        .firecracker-container:hover {
            transform: scale(1.1);
        }

        .firecracker-container.left {
            left: 20px;
            transform-origin: bottom left;
        }

        .firecracker-container.right {
            right: 20px;
            transform-origin: bottom right;
        }

        .fc-body {
            width: 50px;
            height: 140px;
            background: #d80000;
            border-radius: 8px;
            border: 2px solid #ffde00;
            position: relative;
            box-shadow: 2px 5px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: center;
        }

        /* é‡‘è‰²æ¡çº¹ */
        .fc-stripe {
            width: 100%;
            height: 5px;
            background: #ffde00;
        }

        /* ç¦å­— */
        .fc-char {
            color: #ffde00;
            font-weight: bold;
            font-size: 28px;
            border: 2px solid #ffde00;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            line-height: 32px;
            text-align: center;
            background: #b30000;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* å¼•ä¿¡ */
        .fc-fuse {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 20px;
            background: #8B4513;
            border-radius: 2px;
        }

        /* ç«èŠ± */
        .fc-spark {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #fff 10%, #ffde00 40%, #ff4500 80%);
            border-radius: 50%;
            animation: spark-flash 0.1s infinite alternate;
            box-shadow: 0 0 10px #ff4500;
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4 text-white pb-20 relative">

    <!-- è£…é¥°: ç¯ç¬¼ -->
    <div class="lantern" style="left: 10%; animation-delay: 0s;">
        <div class="lantern-line"></div>
        <div class="lantern-body"></div>
        <div class="lantern-tassel"></div>
    </div>
    <div class="lantern" style="right: 10%; animation-delay: 1.5s;">
        <div class="lantern-line"></div>
        <div class="lantern-body"></div>
        <div class="lantern-tassel"></div>
    </div>

    <!-- è£…é¥°: å¯¹è” (æ¡Œé¢ç«¯) -->
    <div class="couplet left">æ°”æ¸©èŠ‚èŠ‚é«˜</div>
    <div class="couplet right">æ—¥å­çº¢ç«ç«</div>

    <!-- è£…é¥°: çˆ†ç«¹ (åº•éƒ¨) -->
    <div class="firecracker-container left">
        <div class="fc-spark"></div>
        <div class="fc-fuse"></div>
        <div class="fc-body">
            <div class="fc-stripe"></div>
            <div class="fc-char">ç¦</div>
            <div class="fc-stripe"></div>
        </div>
    </div>
    <div class="firecracker-container right">
        <div class="fc-spark"></div>
        <div class="fc-fuse"></div>
        <div class="fc-body">
            <div class="fc-stripe"></div>
            <div class="fc-char">æ˜¥</div>
            <div class="fc-stripe"></div>
        </div>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div id="main-card"
        class="glass p-8 md:p-10 rounded-3xl shadow-2xl max-w-md w-full text-center fade-in relative overflow-hidden z-10 transition-all duration-500">
        <h1 class="text-2xl font-bold mb-2 tracking-wide text-white drop-shadow-md">ğŸ§§ æ˜¥èŠ‚æ°”æ¸©å¤§æ¯”æ‹¼ ğŸ§¨</h1>
        <p class="text-white/80 text-sm mb-8">çœ‹çœ‹è°å®¶æœ€çƒ­ï¼Ÿ</p>

        <div class="mb-8 relative">
            <div class="flex justify-center items-baseline space-x-2">
                <span id="temp" class="text-8xl font-thin tracking-tighter drop-shadow-lg">--</span>
                <span class="text-4xl text-white/60 font-light">Â°C</span>
            </div>
            <div id="loading-spinner" class="hidden absolute inset-0 flex items-center justify-center bg-transparent">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            </div>
        </div>

        <p id="status"
            class="text-sm font-medium text-white/90 mb-6 bg-black/20 py-2 px-4 rounded-full inline-block backdrop-blur-sm border border-white/10 shadow-inner max-w-full truncate">
            â³ ç³»ç»Ÿåˆå§‹åŒ–...
        </p>

        <button id="mainBtn" onclick="collectData()"
            class="w-full bg-white text-red-500 font-bold py-4 px-6 rounded-2xl transition-all hover:bg-opacity-90 active:scale-95 shadow-lg relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed">
            åˆ·æ–°æˆ‘çš„æ¸©åº¦
        </button>
    </div>

    <!-- æ’è¡Œæ¦œå¡ç‰‡ (åˆå§‹éšè—) -->
    <div id="leaderboard-card" class="hidden glass mt-6 p-6 rounded-3xl shadow-2xl max-w-md w-full fade-in z-0">
        <h2 class="text-xl font-bold mb-4 text-center border-b border-white/20 pb-2">ğŸ”¥ å…¨å›½é«˜æ¸©æ¦œ TOP 10</h2>
        <div id="leaderboard-list" class="space-y-3 max-h-[300px] overflow-y-auto no-scrollbar">
            <div class="text-center text-white/50 py-4">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <!-- Modal: è¾“å…¥æ˜µç§° (åˆå§‹éšè—) -->
    <div id="modal-backdrop"
        class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm fade-in">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs text-center shadow-2xl slide-up">
            <h3 class="text-2xl font-bold text-red-500 mb-2">å¤ªçƒ­äº†ï¼ğŸ¥µ</h3>
            <p class="text-slate-500 text-sm mb-6">å½“å‰ä½ç½® <span id="modal-district"
                    class="font-bold text-slate-700">--</span> æ°”æ¸©é«˜è¾¾ <span id="modal-temp"
                    class="font-bold text-red-500 text-lg">--</span>Â°C</p>

            <input type="text" id="nickname-input" placeholder="è¾“å…¥æ˜µç§° (ä¾‹å¦‚: å¹¿å·å´å½¦ç¥–)"
                class="w-full bg-slate-100 border border-slate-200 text-slate-800 text-center rounded-xl py-3 px-4 mb-4 focus:outline-none focus:ring-2 focus:ring-red-400 font-bold placeholder:font-normal">

            <button onclick="joinLeaderboard()"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 transition-all active:scale-95">
                ğŸ”¥ åŠ å…¥æ¯”æ‹¼
            </button>
            <button onclick="closeModal()" class="mt-3 text-slate-400 text-xs hover:text-slate-600">
                ä½è°ƒè·¯è¿‡ï¼Œä¸å‚ä¸
            </button>
        </div>
    </div>

    <!-- æ ¸å¿ƒé€»è¾‘ -->
    <script>
        // === æ ¸å¿ƒé…ç½® ===
        const AMAP_KEY = 'e1fc7c73639f76133ba37398e9d68ffe';
        const SUPABASE_URL = 'https://rhgvuveblnwznemndvpx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_OjgMOfIsUcOK9iYSuZ76wg_6FEvzdB8';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        let currentData = { temp: null, lat: null, lon: null, district: null };

        async function collectData() {
            const btn = document.getElementById('mainBtn');
            const status = document.getElementById('status');
            const tempDisplay = document.getElementById('temp');
            const spinner = document.getElementById('loading-spinner');

            btn.disabled = true;
            spinner.classList.remove('hidden');
            tempDisplay.classList.add('opacity-50');
            status.innerText = "ğŸ“ æ­£åœ¨å®šä½...";

            if (!navigator.geolocation) {
                status.innerText = "âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½";
                resetUI();
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lon = pos.coords.longitude.toFixed(6);
                const lat = pos.coords.latitude.toFixed(6);
                const locationStr = `${lon},${lat}`;

                status.innerText = `ğŸŒ å®šä½æˆåŠŸï¼Œè§£æä¸­...`;

                try {
                    // 1. é€†åœ°ç†ç¼–ç 
                    const geoRes = await fetch(`https://restapi.amap.com/v3/geocode/regeo?location=${locationStr}&key=${AMAP_KEY}`);
                    const geoData = await geoRes.json();

                    if (geoData.info !== "OK") throw new Error(geoData.info);

                    const adcode = geoData.regeocode.addressComponent.adcode;
                    const district = geoData.regeocode.addressComponent.district;
                    const city = geoData.regeocode.addressComponent.city;
                    const locationName = (typeof district === 'string' && district.length > 0) ? district : city;

                    status.innerText = `ğŸ“ ${locationName} | è¯»å–æ°”æ¸©...`;

                    // 2. è·å–å¤©æ°” (å›å½’é«˜å¾· APIï¼Œå¹¶å¢åŠ éšæœºå°æ•°ä½)
                    const weatherRes = await fetch(`https://restapi.amap.com/v3/weather/weatherInfo?city=${adcode}&key=${AMAP_KEY}`);
                    const weatherData = await weatherRes.json();

                    if (weatherData.info === "OK" && weatherData.lives.length > 0) {
                        let t = parseFloat(weatherData.lives[0].temperature);

                        // === å¼ºè¡Œå¢åŠ å°æ•°ä½ç²¾åº¦ ===
                        // ä¹‹å‰ç®—æ³• [-0.5, 0.5] ä»ç„¶å¯èƒ½å¾®å°åå·®
                        // æ”¹ä¸º [0-9] éšæœºæ•´æ•°æ˜ å°„ï¼Œç»å¯¹ä¿è¯ 10% çš„æ¦‚ç‡
                        // é€»è¾‘: å– -0.5 åˆ° +0.4 çš„åç§»é‡
                        const randomLastDigit = Math.floor(Math.random() * 10); // 0-9
                        const jitter = (randomLastDigit - 5) / 10;
                        t += jitter;

                        // æœ€ç»ˆä¿ç•™1ä½å°æ•°
                        const t_fixed = t.toFixed(1);

                        // æ›´æ–° State
                        currentData = { temp: parseFloat(t_fixed), lat: lat, lon: lon, district: locationName };

                        // æ›´æ–° UI
                        tempDisplay.innerText = t_fixed;
                        tempDisplay.classList.remove('opacity-50');
                        spinner.classList.add('hidden');
                        status.innerText = "âœ… æµ‹æ¸©å®Œæˆ";

                        // å¼¹å‡º PK Modal
                        openModal(t_fixed, locationName);

                    } else {
                        throw new Error("å¤©æ°”æŸ¥è¯¢å¤±è´¥");
                    }
                } catch (e) {
                    console.error(e);
                    status.innerText = "ğŸš¨ " + e.message;
                    tempDisplay.innerText = "--";
                } finally {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    tempDisplay.classList.remove('opacity-50');
                }
            }, (err) => {
                let errorMsg = "å®šä½å¤±è´¥";
                if (err.code === err.PERMISSION_DENIED) errorMsg = "è¯·å…è®¸å®šä½æƒé™";
                status.innerText = "âš ï¸ " + errorMsg;
                btn.disabled = false;
                spinner.classList.add('hidden');
                tempDisplay.classList.remove('opacity-50');
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        // === Modal & Leaderboard Logic ===

        function openModal(temp, district) {
            document.getElementById('modal-temp').innerText = temp;
            document.getElementById('modal-district').innerText = district;
            document.getElementById('modal-backdrop').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            // å³ä½¿ä¸å‚åŠ ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹æ¦œå•ï¼ˆå¯é€‰ï¼‰
            fetchAndShowLeaderboard();
        }

        async function joinLeaderboard() {
            const nickname = document.getElementById('nickname-input').value.trim() || 'ç¥ç§˜ç½‘å‹';
            const btn = document.querySelector('#modal-backdrop button'); // Get the join button
            const status = document.getElementById('status');

            // UI Feedback inside modal
            btn.innerText = "â³ ä¸Šä¼ ä¸­...";
            btn.disabled = true;

            try {
                // ä¸Šä¼ æ•°æ®
                const { error } = await supabaseClient
                    .from('weather_logs')
                    .insert([{
                        temp: currentData.temp,
                        lat: currentData.lat,
                        lon: currentData.lon,
                        nickname: nickname,
                        district: currentData.district
                    }]);

                if (error) throw error;

                // æˆåŠŸå
                closeModal();
                status.innerText = "ğŸ‰ å·²åŠ å…¥æ’è¡Œæ¦œï¼";
                await fetchAndShowLeaderboard();

            } catch (e) {
                alert("åŠ å…¥å¤±è´¥: " + e.message);
                btn.innerText = "ğŸ”¥ åŠ å…¥æ¯”æ‹¼";
                btn.disabled = false;
            }
        }

        async function fetchAndShowLeaderboard() {
            const listEl = document.getElementById('leaderboard-list');
            const cardEl = document.getElementById('leaderboard-card');

            cardEl.classList.remove('hidden');
            listEl.innerHTML = '<div class="text-center text-white/50 py-4">åˆ·æ–°æ¦œå•ä¸­...</div>';

            try {
                // è·å– Top 20 (é˜²æ­¢æŸäº›æ— ç”¨çš„æµ‹è¯•æ•°æ®ï¼Œå–å¤šä¸€ç‚¹)
                const { data, error } = await supabaseClient
                    .from('weather_logs')
                    .select('nickname, district, temp, created_at')
                    .order('temp', { ascending: false }) // æŒ‰æ¸©åº¦å€’åº
                    .limit(20);

                if (error) throw error;

                // æ¸²æŸ“åˆ—è¡¨
                let html = '';
                data.forEach((item, index) => {
                    // ç®€å•çš„å¥–ç‰Œæ ·å¼
                    let rankStyle = "text-white/60 text-sm";
                    let rowBg = "bg-white/5";
                    if (index === 0) { rankStyle = "text-yellow-300 font-bold text-xl"; rowBg = "bg-yellow-500/20 box-border border border-yellow-300/30"; }
                    else if (index === 1) { rankStyle = "text-gray-300 font-bold text-lg"; rowBg = "bg-gray-500/20"; }
                    else if (index === 2) { rankStyle = "text-orange-300 font-bold text-lg"; rowBg = "bg-orange-500/20"; }

                    const name = item.nickname || 'åŒ¿åæ­¤';
                    const loc = item.district || 'æœªçŸ¥åœ°åŒº';
                    let tempVal = parseFloat(item.temp);
                    const tempStr = isNaN(tempVal) ? '--' : tempVal.toFixed(1);

                    html += `
                        <div class="flex justify-between items-center p-3 rounded-xl ${rowBg} transition hover:bg-white/10">
                            <div class="flex items-center gap-4">
                                <span class="w-6 text-center ${rankStyle}">${index + 1}</span>
                                <div class="text-left">
                                    <div class="font-bold text-sm text-white/90 truncate max-w-[100px]">${sanitize(name)}</div>
                                    <div class="text-xs text-white/50">${sanitize(loc)}</div>
                                </div>
                            </div>
                            <span class="text-lg font-bold text-white">${tempStr}Â°</span>
                        </div>
                    `;
                });

                if (data.length === 0) html = '<div class="text-center text-white/50">æš‚æ— æ•°æ®ï¼Œå¿«æ¥æŠ¢å ç¬¬ä¸€!</div>';
                listEl.innerHTML = html;

            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<div class="text-center text-red-300 py-4">åŠ è½½å¤±è´¥</div>';
            }
        }

        // XSS simple protection
        function sanitize(str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function resetUI() {
            const btn = document.getElementById('mainBtn');
            btn.disabled = false;
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('temp').classList.remove('opacity-50');
        }

        window.addEventListener('load', () => {
            // é¡µé¢åŠ è½½åŒæ ·è‡ªåŠ¨è§¦å‘ä¸€æ¬¡ï¼Œä½†ä¸ä¸€å®šå¼ºåˆ¶å¼¹çª—ï¼Œæˆ–è€…å¯ä»¥ï¼Ÿ
            // ç°åœ¨çš„é€»è¾‘æ˜¯ collectData -> æˆåŠŸ -> openModal
            // è¿™æ ·ç”¨æˆ·ä¸€æ‰“å¼€å°±è‡ªåŠ¨æµ‹æ¸©å¹¶å¼¹çª—ï¼Œç¬¦åˆâ€œæ˜¥èŠ‚çƒ­é—¹â€çš„æ„Ÿè§‰
            collectData();
        });
    </script>
</body>

</html>
