<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°”æ¸©é‡‡é›†åŠ©æ‰‹ v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-slate-100">
        <h1 class="text-xl font-medium mb-8 text-slate-600">å®æ—¶æ°”æ¸©é‡‡é›†</h1>
        <div class="mb-8">
            <span id="temp" class="text-7xl font-light text-blue-600">--</span>
            <span class="text-2xl text-slate-400">Â°C</span>
        </div>
        <p id="status" class="text-xs text-slate-500 mb-8 bg-slate-50 py-3 px-4 rounded-xl leading-relaxed">å‡†å¤‡å°±ç»ª</p>
        <button id="mainBtn" onclick="collectData()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all active:scale-95 shadow-lg shadow-blue-200">
            è·å–å¹¶åŒæ­¥æ•°æ®
        </button>
    </div>

    <script>
        // === é…ç½®ç¡®è®¤åŒº ===
        const QWEATHER_KEY = '40f1fce96ebb4b13ac7ce937c31c1012'; 
        const SUPABASE_URL = 'https://rhgvuveblnwznemndvpx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_OjgMOfIsUcOK9iYSuZ76wg_6FEvzdB8';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function collectData() {
            const btn = document.getElementById('mainBtn');
            const status = document.getElementById('status');
            const tempDisplay = document.getElementById('temp');
            
            btn.disabled = true;
            status.innerText = "ğŸ“ æ­£åœ¨è·å–åœ°ç†ä½ç½®...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude.toFixed(4);
                const lon = pos.coords.longitude.toFixed(4);
                status.innerText = `ğŸŒ å®šä½æˆåŠŸ: ${lat}, ${lon}\næ­£åœ¨æŸ¥è¯¢å¤©æ°”...`;

                try {
                    // ä½¿ç”¨å’Œé£å¤©æ°”å¼€å‘ç‰ˆ API æ¥å£
                    const weatherUrl = `https://devapi.qweather.com/v7/weather/now?location=${lon},${lat}&key=${QWEATHER_KEY}`;
                    const res = await fetch(weatherUrl);
                    
                    if (!res.ok) {
                        throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${res.status})`);
                    }

                    const data = await res.json();
                    
                    // è¯¦ç»†åˆ¤æ–­è¿”å›ç 
                    if (data.code === "200") {
                        const t = data.now.temp;
                        tempDisplay.innerText = t;
                        status.innerText = "â˜ï¸ å¤©æ°”è·å–æˆåŠŸï¼ŒåŒæ­¥åå°ä¸­...";

                        // å†™å…¥æ•°æ®åº“
                        const { error: sbError } = await supabaseClient
                            .from('weather_logs')
                            .insert([{ temp: t, lat: lat, lon: lon }]);

                        if (sbError) throw new Error("æ•°æ®åº“å†™å…¥å¤±è´¥: " + sbError.message);
                        
                        status.innerText = "âœ… æ•°æ®åŒæ­¥æˆåŠŸï¼";
                    } else {
                        // å¤„ç†å’Œé£å¤©æ°”çš„é€»è¾‘é”™è¯¯ç 
                        const errorMap = {
                            "401": "API Key é”™è¯¯æˆ–å¤±æ•ˆ",
                            "403": "æ— æƒè®¿é—®ï¼Œè¯·æ£€æŸ¥å’Œé£ç™½åå•è®¾ç½®",
                            "404": "æŸ¥è¯¢ä½ç½®ä¸å­˜åœ¨",
                            "429": "è®¿é—®è¿‡äºé¢‘ç¹"
                        };
                        status.innerText = `âŒ æŸ¥è¯¢å¤±è´¥: ${errorMap[data.code] || 'é”™è¯¯ç  ' + data.code}`;
                    }
                } catch (e) {
                    status.innerText = "ğŸš¨ å‘ç”Ÿé”™è¯¯: " + e.message;
                } finally { 
                    btn.disabled = false; 
                }
            }, (err) => {
                const errMsgs = {
                    1: "æ‚¨æ‹’ç»äº†ä½ç½®æˆæƒï¼Œè¯·åœ¨è®¾ç½®ä¸­å¼€å¯",
                    2: "æ— æ³•è·å–å½“å‰ä½ç½®",
                    3: "å®šä½è¶…æ—¶"
                };
                status.innerText = "ğŸ“ å®šä½å¤±è´¥: " + (errMsgs[err.code] || err.message);
                btn.disabled = false;
            }, { timeout: 10000 });
        }
    </script>
</body>
</html>
